<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoundLink+ Streamer</title>
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
      import { getDatabase, ref, set, onValue, push, remove, get } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyAo1x1x1F-zZU5uZDgg24N4gVCL9Xl9QmA",
        authDomain: "soundlink-plus.firebaseapp.com",
        projectId: "soundlink-plus",
        storageBucket: "soundlink-plus.appspot.com",
        messagingSenderId: "930608446048",
        appId: "1:930608446048:web:dc7ae85f5a60d60bc96105",
        measurementId: "G-007FXMK57J"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);

      let peerConnection;
      let microphoneStream;

      function initializeWebRTC() {
        const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        peerConnection = new RTCPeerConnection(configuration);

        // Add microphone stream to peer connection
        if (microphoneStream) {
          microphoneStream.getTracks().forEach(track => peerConnection.addTrack(track, microphoneStream));
        }

        // Handle ICE candidate events
        peerConnection.onicecandidate = event => {
          if (event.candidate) {
            console.log('New ICE candidate:', event.candidate);
            push(ref(database, 'candidates'), JSON.stringify(event.candidate));
          }
        };

        // Handle negotiation needed event
        peerConnection.onnegotiationneeded = () => {
          peerConnection.createOffer()
            .then(offer => peerConnection.setLocalDescription(offer))
            .then(() => {
              set(ref(database, 'offer'), JSON.stringify(peerConnection.localDescription));
              console.log('Offer created:', peerConnection.localDescription);
            })
            .catch(error => {
              console.error('Error creating offer:', error);
            });
        };
      }

      function startMicrophone() {
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(stream => {
            microphoneStream = stream;
            console.log('Microphone access granted');
          })
          .catch(error => {
            console.error('Error accessing microphone:', error);
          });
      }

      function stopMicrophone() {
        if (microphoneStream) {
          microphoneStream.getTracks().forEach(track => track.stop());
          console.log('Microphone stopped');
        }
      }

      function playAudio(filename) {
        let audio = new Audio(filename);
        audio.play();
      }

      function startStreaming() {
        console.log('Starting streaming...');
        initializeWebRTC();
      }

      function stopStreaming() {
        if (peerConnection) {
          peerConnection.close();
          remove(ref(database, 'offer'));
          remove(ref(database, 'candidates'));
          console.log('Streaming stopped');
        }
      }

      window.startMicrophone = startMicrophone;
      window.stopMicrophone = stopMicrophone;
      window.playAudio = playAudio;
      window.startStreaming = startStreaming;
      window.stopStreaming = stopStreaming;

    </script>
</head>
<body>
    <h1>Audio Streamer</h1>

    <!-- Streaming controls -->
    <div id="streamingControls">
        <button onclick="playAudio('mp3/intro.mp3')">Intro</button>
        <button onclick="playAudio('audio2.mp3')">Play Audio 2</button>

        <hr>

        <label>
            <input type="checkbox" id="desktopAudioCheckbox"> Include Desktop Audio
        </label>

        <hr>

        <h2>Microphone Audio</h2>
        <button onclick="startMicrophone()">Start Microphone</button>
        <button onclick="stopMicrophone()">Stop Microphone</button>
        <hr>

        <button onclick="startStreaming()">Start Streaming</button>
        <button onclick="stopStreaming()">Stop Streaming</button>
    </div>
</body>
</html>
